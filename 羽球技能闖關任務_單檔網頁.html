<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>羽球技能闖關任務</title>

  <!-- Fonts & UI -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --ink: #263159;
      --primary: #FF8F52;
      --primary-600: #FF7A3D;
      --headline: #495579;
      --paper: #FFFBEB;
      --muted: #EAEFFB;
    }
    html, body { height: 100%; }
    body {
      font-family: 'Noto Sans TC', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', sans-serif;
      background-color: var(--paper);
      color: var(--ink);
    }
    .chart-container {
      position: relative;
      width: 100%;
      max-width: 200px;
      height: 200px;
      margin-left: auto;
      margin-right: auto;
    }
    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,.5);
      display: none; /* hidden by default */
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-overlay.open { display: flex; }
    .modal-content {
      background-color: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0,0,0,.2);
      width: 90%;
      max-width: 640px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }
    .close-button {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      font-size: 1.8rem;
      line-height: 1;
      cursor: pointer;
      color: var(--headline);
    }
    /* Loader */
    .loader {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 4px solid #e5e7eb;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
      margin: 0 auto 0.75rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <header class="text-center mb-10">
      <h1 class="text-4xl md:text-5xl font-bold text-[var(--headline)] mb-4">羽球技能闖關任務單</h1>
      <p class="text-lg md:text-xl max-w-3xl mx-auto">請與你的搭檔一起完成以下五個關卡。每次闖關時請錄影，過關後請授課老師確認。</p>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      <!-- 卡片元件：可複用 -->
      <section class="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center text-center transform hover:scale-105 transition-transform duration-300">
        <h2 class="text-2xl font-bold text-[var(--headline)] mb-4">關卡一：後場高遠球</h2>
        <div class="chart-container mb-4">
          <canvas id="chart1" aria-label="後場高遠球目標次數圖表" role="img"></canvas>
        </div>
        <div class="flex-grow flex flex-col justify-between w-full">
          <div>
            <h3 class="font-bold text-lg mb-1">目標</h3>
            <p class="mb-4">在後場將球打高，讓球飛過對手頭頂，落在對方後場區域。</p>
            <h3 class="font-bold text-lg mb-1">執行方式</h3>
            <p>與搭檔站在場地兩端底線附近，連續 <span class="text-3xl font-bold text-[var(--primary)]">5</span> 次成功將球打到後場區域即可過關。</p>
          </div>
          <button class="mt-6 px-6 py-3 bg-[var(--primary)] text-white font-bold rounded-full shadow-md hover:bg-[var(--primary-600)] transition-colors duration-300" onclick="showExplanation('後場高遠球')">✨ 說明術語</button>
        </div>
      </section>

      <section class="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center text-center transform hover:scale-105 transition-transform duration-300">
        <h2 class="text-2xl font-bold text-[var(--headline)] mb-4">關卡二：網前放球</h2>
        <div class="chart-container mb-4">
          <canvas id="chart2" aria-label="網前放球目標次數圖表" role="img"></canvas>
        </div>
        <div class="flex-grow flex flex-col justify-between w-full">
          <div>
            <h3 class="font-bold text-lg mb-1">目標</h3>
            <p class="mb-4">練習控制球的力道，讓球輕柔地飛過網子，落在網前區域。</p>
            <h3 class="font-bold text-lg mb-1">執行方式</h3>
            <p>與搭檔站在網前，將球輕輕推過網，連續 <span class="text-3xl font-bold text-[var(--primary)]">5</span> 次成功讓球落在網前 1 公尺的區域內即可過關。</p>
          </div>
          <button class="mt-6 px-6 py-3 bg-[var(--primary)] text-white font-bold rounded-full shadow-md hover:bg-[var(--primary-600)] transition-colors duration-300" onclick="showExplanation('網前放球')">✨ 說明術語</button>
        </div>
      </section>

      <section class="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center text-center transform hover:scale-105 transition-transform duration-300">
        <h2 class="text-2xl font-bold text-[var(--headline)] mb-4">關卡三：殺球練習</h2>
        <div class="chart-container mb-4">
          <canvas id="chart3" aria-label="殺球練習目標次數圖表" role="img"></canvas>
        </div>
        <div class="flex-grow flex flex-col justify-between w-full">
          <div>
            <h3 class="font-bold text-lg mb-1">目標</h3>
            <p class="mb-4">學習殺球的揮拍動作和向下發力。</p>
            <h3 class="font-bold text-lg mb-1">執行方式</h3>
            <p>搭檔將球拋到你頭頂上方，你跳起並用力將球向下打出，連續 <span class="text-3xl font-bold text-[var(--primary)]">3</span> 次成功將球打到對面場地即可過關。</p>
          </div>
          <button class="mt-6 px-6 py-3 bg-[var(--primary)] text-white font-bold rounded-full shadow-md hover:bg-[var(--primary-600)] transition-colors duration-300" onclick="showExplanation('殺球練習')">✨ 說明術語</button>
        </div>
      </section>

      <section class="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center text-center transform hover:scale-105 transition-transform duration-300 md:col-span-2 lg:col-span-1 lg:col-start-2">
        <h2 class="text-2xl font-bold text-[var(--headline)] mb-4">關卡四：基礎對打</h2>
        <div class="chart-container mb-4">
          <canvas id="chart4" aria-label="基礎對打目標次數圖表" role="img"></canvas>
        </div>
        <div class="flex-grow flex flex-col justify-between w-full">
          <div>
            <h3 class="font-bold text-lg mb-1">目標</h3>
            <p class="mb-4">培養基本的回擊能力和協調性。</p>
            <h3 class="font-bold text-lg mb-1">執行方式</h3>
            <p>與搭檔在場地中央附近，以輕鬆的力道將球來回對打，連續 <span class="text-3xl font-bold text-[var(--primary)]">10</span> 次來回不落地即可過關。</p>
          </div>
          <button class="mt-6 px-6 py-3 bg-[var(--primary)] text-white font-bold rounded-full shadow-md hover:bg-[var(--primary-600)] transition-colors duration-300" onclick="showExplanation('基礎對打')">✨ 說明術語</button>
        </div>
      </section>

      <section class="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center text-center transform hover:scale-105 transition-transform duration-300 md:col-start-1 md:col-end-3 lg:col-start-auto lg:col-end-auto">
        <h2 class="text-2xl font-bold text-[var(--headline)] mb-4">關卡五：米字步法</h2>
        <div class="chart-container mb-4">
          <canvas id="chart5" aria-label="米字步法時間圖表" role="img"></canvas>
        </div>
        <div class="flex-grow flex flex-col justify-between w-full">
          <div>
            <h3 class="font-bold text-lg mb-1">目標</h3>
            <p class="mb-4">熟悉羽球場上各個位置的移動腳步。</p>
            <h3 class="font-bold text-lg mb-1">執行方式</h3>
            <p>在場地中央，依序向八個方向移動並回到中心，在 <span class="text-3xl font-bold text-[var(--primary)]">60</span> 秒內成功完成一個完整的循環即可過關。</p>
          </div>
          <button class="mt-6 px-6 py-3 bg-[var(--primary)] text-white font-bold rounded-full shadow-md hover:bg-[var(--primary-600)] transition-colors duration-300" onclick="showExplanation('米字步法')">✨ 說明術語</button>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal -->
  <div id="explanationModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
      <button class="close-button" aria-label="關閉" onclick="closeModal()">&times;</button>
      <h2 id="modalTitle" class="text-3xl font-bold text-[var(--headline)] mb-4"></h2>
      <div id="modalBody">
        <p id="modalContent" class="text-base leading-relaxed"></p>
        <div id="modalLoading" class="text-center mt-4 hidden">
          <div class="loader" aria-hidden="true"></div>
          <div class="text-[var(--headline)]">載入中…</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -------------------------------
    // Chart.js center text plugin
    // -------------------------------
    const centerTextPlugin = {
      id: 'centerText',
      afterDraw: (chart) => {
        const { ctx, canvas, chartArea } = chart;
        if (!chartArea) return; // Guard for animations not finished
        const centerX = (chartArea.left + chartArea.right) / 2;
        const centerY = (chartArea.top + chartArea.bottom) / 2;
        const text = chart.options.plugins.centerText?.text ?? '';
        const unit = chart.options.plugins.centerText?.unit ?? '';

        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = "bold 48px 'Noto Sans TC'";
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#FF8F52';
        ctx.fillText(String(text), centerX, centerY - 10);

        ctx.font = "bold 18px 'Noto Sans TC'";
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--headline').trim() || '#495579';
        ctx.fillText(String(unit), centerX, centerY + 28);
        ctx.restore();
      }
    };
    Chart.register(centerTextPlugin);

    function createChallengeChart(canvasId, targetNumber, unit) {
      const el = document.getElementById(canvasId);
      if (!el) return;
      const ctx = el.getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: [unit, ''],
          datasets: [{
            data: [targetNumber, 0.0001],
            backgroundColor: ['#FF8F52', '#EAEFFB'],
            borderColor: '#ffffff',
            borderWidth: 4,
            hoverBorderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '80%',
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false },
            centerText: { text: targetNumber, unit }
          }
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      createChallengeChart('chart1', 5, '次');
      createChallengeChart('chart2', 5, '次');
      createChallengeChart('chart3', 3, '次');
      createChallengeChart('chart4', 10, '次');
      createChallengeChart('chart5', 60, '秒');

      // 允許 ESC 關閉視窗
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
      // 點擊遮罩關閉
      document.getElementById('explanationModal').addEventListener('click', (e) => {
        if (e.target.id === 'explanationModal') closeModal();
      });
    });

    // -------------------------------
    // Modal helpers
    // -------------------------------
    const explanationModal = document.getElementById('explanationModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    const modalLoading = document.getElementById('modalLoading');

    function openModal() { explanationModal.classList.add('open'); }
    function closeModal() {
      explanationModal.classList.remove('open');
      modalTitle.textContent = '';
      modalContent.textContent = '';
      modalLoading.classList.add('hidden');
    }

    // 將缺失的 showExplanation() 接上 API 呼叫
    function showExplanation(term) {
      callGeminiAPI(term);
    }

    // -------------------------------
    // Gemini API 呼叫 + 本地備援詞彙
    // -------------------------------
    const LOCAL_GLOSSARY = {
      '後場高遠球': '高遠球是從後場將球高弧度打向對方後場的基本技術。重點是準備姿勢要側身、引拍完整、擊球點在身體前上方，出拍時手臂放鬆加上身體轉動。練習時想像把球「送上去、送到遠方」。',
      '網前放球': '放小球需要細膩手感。球拍面要穩、力量小而連續，讓球貼網下墜。擊球點通常在胸口到肩膀之間、靠近網帶位置。練習時可先固定腳步，專注拍面角度與觸球時間。',
      '殺球練習': '殺球是向下的進攻球。重點是抬肘引拍、身體向前上方延伸，擊球點在最高點稍前方，落地要有緩衝。先學「快、準、穩」，再追求「重」。',
      '基礎對打': '基礎對打強調節奏與穩定。用七成功力、球過中線即回，專注於步伐到位、拍面穩、落點清楚。可設定「一高一平」的節奏先建立穩定度。',
      '米字步法': '米字步法模擬場上八方向移動（前、後、左、右與四個斜線）。關鍵是起動快、最後兩步小碎步調整到位、回中立位時身體重心保持在前腳掌。可搭配節拍器訓練節奏。'
    };

    async function callGeminiAPI(term) {
      openModal();
      modalTitle.textContent = `「${term}」說明`;
      modalContent.textContent = '';
      modalLoading.classList.remove('hidden');

      const systemPrompt = '你是一位專業且耐心友善的羽球教練，請用簡單易懂的方式，為羽球初學者解釋以下術語。請避免使用過於專業的術語，並提供實際的建議或想像，讓他們能輕鬆理解。';
      const userQuery = `請解釋「${term}」這個羽球術語。`;

      // 👉 在此填入你的 Gemini API Key（可留空改用本地備援）
      const apiKey = '';
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

      // 若未設定 API Key，使用本地備援說明
      if (!apiKey) {
        await new Promise(r => setTimeout(r, 300)); // 小延遲較有互動感
        modalContent.textContent = LOCAL_GLOSSARY[term] || '目前無此術語的預設說明，請向老師提問或稍後再試。';
        modalLoading.classList.add('hidden');
        return;
      }

      const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        systemInstruction: { parts: [{ text: systemPrompt }] }
      };

      let retryDelay = 800;
      const maxRetries = 4;
      for (let i = 0; i < maxRetries; i++) {
        try {
          const resp = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (resp.status === 429) {
            await new Promise(r => setTimeout(r, retryDelay));
            retryDelay *= 2; // 指數退避
            continue;
          }

          if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(`API 錯誤：${resp.status}${err?.error?.message ? ' - ' + err.error.message : ''}`);
          }

          const data = await resp.json();
          const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
          modalContent.textContent = text || (LOCAL_GLOSSARY[term] ?? '抱歉，無法取得說明內容。');
          break;
        } catch (e) {
          // 最後一次失敗改用本地備援
          if (i === maxRetries - 1) {
            modalContent.textContent = LOCAL_GLOSSARY[term] || `抱歉，載入失敗：${e.message}`;
          } else {
            await new Promise(r => setTimeout(r, retryDelay));
            retryDelay *= 2;
          }
        }
      }
      modalLoading.classList.add('hidden');
    }
  </script>
</body>
</html>
